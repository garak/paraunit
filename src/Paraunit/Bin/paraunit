#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/../../../../../autoload.php')) {
    require_once __DIR__ . '/../../../../../autoload.php';
} elseif (file_exists(__DIR__ . '/../../../vendor/autoload.php')) {
    // Required for local testing
    require_once __DIR__ . '/../../../vendor/autoload.php';
} else {
    throw new \Exception('Autoload not found');
}

if (!ini_get('date.timezone') && !date_default_timezone_get()) {
    date_default_timezone_set('UTC');
}

use Paraunit\Command\ParallelCommand;
use Paraunit\Command\CoverageCommand;
use Symfony\Component\Console\Application;

require_once __DIR__ . '/../../../Container.php';

/** @var \Paraunit\Filter\Filter $filter */
$filter = $container->get('paraunit.filter.filter');
/** @var \Paraunit\Runner\ParallelRunner $parallelRunner */
$parallelRunner = $container->get('paraunit.runner.parallel_runner');
/** @var \Paraunit\Runner\CoverageRunner $coverageRunner */
$coverageRunner = $container->get('paraunit.runner.coverage_runner');

$parallelCommand = new ParallelCommand($filter, $parallelRunner);
$coverageCommand = new CoverageCommand($filter, $coverageRunner);

// HOTFIX -- needed to fool the Symfony's WebTestCase
$_SERVER['argv'][0] = 'phpunit';

$application = new Application('Paraunit', '0.4');
$application->add($parallelCommand);
$application->add($coverageCommand);
$application->run();